<!DOCTYPE HTML>
<html>
<head>
<title>GeoHash Test</title>
<style>
input{
display:block;
}
span{
display:inline-block;
background-color:#bcdcac;
margin:10px;
padding: 10px;
}
</style>
<script>
function reduce(input, output){
    var center = (input[1] + input[2]) * 0.5;
    
    if (input[0] > center){
        output.push(1);
        input[1] = center;
        return 1;
    }
    output.push(0);
    input[2] = center;
    return 0;
}
// base32hex
function stringify(bitfield){
    
    for(var i=bitfield.length-1, c=0, value=0, text=''; i>-1; c++, i--){
        value += bitfield[i] << c;
        if (29 === c){
            text = value.toString(32) + text;
            c = -1;
            value = 0;
        }
    }
    if (value){
        text = value.toString(32) + text;
    }
    return text;
}
// latitude then longitude
// position=1, negative=0
function hash(lat, lng, accuracy){
    var
    bitfield=[],
    data = [ [lat, -90, 90], [lng, -180, 180] ];
    
    for(var i=0; i<accuracy; i++){
        reduce(data[0], bitfield);
        reduce(data[1], bitfield);
    }
    
    return bitfield;
}
function format(bitfield){
    return bitfield.join(',')+'<br>'+stringify(bitfield)+'<br>';
}
function peer(bitfield, relLat, relLng){
    var
    lng = bitfield.pop(),
    lat = bitfield.pop(),
    maskLat = 1 < relLat,
    maskLng = 1 < relLng,
    b = bitfield;
    
    if ((!maskLat && relLat === lat) || (!maskLng && relLng === lng)){
        // relative only maintain if lat and lng all changed
        b = peer(bitfield, lat === relLat ? relLat : 2, lng === relLng ? relLng : 2);
    }
    b.push(maskLat ? lat : (lat ? 0 : 1));
    b.push(maskLng ? lng : (lng ? 0 : 1));
    return b;
}
function scale(range, mat){
    if (!range) return mat;
    range--;
    
    var
    hl = mat.length,
    h = hl - 1,
    vec = mat[0],
    wl = vec.length,
    w = wl - 1,
    row;
    
    // both sides
    for(var y=0; y<hl; y++){
        row = mat[y];
        row.push(peer(row[w].slice(), 2, 1));
        row.unshift(peer(row[0].slice(), 2, 0));
    }
    wl = row.length;
    w = wl - 1;
    
    // bottom row
    row = mat[h];
    vec = [peer(row[1].slice(), 0, 0)];
    for(var x=1; x<wl; x++){
        vec.push(peer(row[x].slice(), 0, 2));
    }
    mat.push(vec);
    
    // top row
    row = mat[0];
    vec = [peer(row[1].slice(), 1, 0)];
    for(var x=1; x<wl; x++){
        vec.push(peer(row[x].slice(), 1, 2));
    }
    mat.unshift(vec);
    
    return scale(range, mat);
}
function map(){
    var
    inputs = document.getElementsByTagName('input'),
    output = document.getElementById('output'),
    accuracy = parseInt(inputs[0].value),
    range = parseInt(inputs[1].value),
    lat = parseFloat(inputs[2].value),
    lng = parseFloat(inputs[3].value),
    bitfield = hash(lat, lng, accuracy),
    mat = scale(range, [[bitfield]]),
    vec;

    output.innerHTML  = '[origin]'+format(bitfield);
    
    for(var y=0, yl=mat.length; y<yl; y++){
        vec = mat[y];
        for(var x=0,xl=vec.length; x<xl; x++){
            output.innerHTML += '['+x+','+y+']'+format(vec[x]);
        } 
    }
}
</script>
</head>
<body>

<form id=test3 method=GET>
<h1>GeoHash Test</h1>
<label>accuracy<input name=accuracy type=number min=1 value=16></input></label>
<label>range<input name=range type=number min=0 value=1></input></label>
<label>latittude<input name=latitude type=number min=-90 max=90 value=1.366667></input></label>
<label>longitude<input name=longitude type=number min=-180 max=180 value=103.983330></input></label>
<label id=test2><a id=test1 href="javascript:map()">search</a></label>
</form>

<span id=output></span>

</body>
</html>
